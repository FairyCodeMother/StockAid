<% content_for :title, "Inventory Reconciliation #{@reconciliation.title}" %>
<% content_for :tabs, render("items/tabs") %>

<% content_for :sidebar do %>
  <%= render "common/category_nav", only_categories: true, path: inventory_reconciliation_path(@reconciliation) %>
<% end %>

<% content_for :content_size, "col-sm-9 col-md-10" %>

<% content_for :content do %>
  <%= javascript_tag do %>
    var reconcileUrl = <%= reconcile_inventory_reconciliation_path(@reconciliation).to_json.html_safe %>;
  <% end %>

  <h3 class="button-height">
    <%= @reconciliation.full_title %>

    <% if @current_user.can_edit_inventory_reconciliation?(@reconciliation) %>
      <%= link_to "Completed", complete_inventory_reconciliation_path(@reconciliation), method: :post, class: "btn btn-danger pull-right", data: confirm(title: "Completing Inventory Reconciliation ##{@reconciliation.id}") %>
    <% end %>
  </h3>

  <%= render partial: "inventory_reconciliations/notes", locals: { expanded: !@category } %>

  <% if @reconciliation.items(params).empty? %>
    <p class="text-danger">
      There are no items to show<%= " for this category" if @category %>!
    </p>
  <% else %>
    <h4>
      <% if @category.present? %>
        <%= @category.description %>
      <% else %>
        All Items
      <% end %>
    </h4>

    <table class="table table-hover table-striped data-table no-paging">
      <thead>
        <tr>
          <th class="col-xs-4">Description</th>
          <th class="text-center">In Stock</th>
          <th class="text-center">Requested</th>
          <% if current_user.can_edit_inventory_reconciliation?(@reconciliation) %>
            <th class="text-center">New Stock</th>
            <th></th>
          <% end %>
        </tr>
      </thead>

      <tbody>
        <% @reconciliation.items(params).each do |item| %>
          <% next if !@reconciliation.reconciled?(item) && @reconciliation.complete %>

          <tr class="<%= "success" if @reconciliation.reconciled?(item) %>" data-toggle="tooltip" data-placement="left" title="<%= item.category.description %>">
            <td class="col-xs-4">
              <span class="hidden"><%= item.category.description %></span>
              <%= item.description %>
            </td>
            <td class="text-center"><%= item.current_quantity %></td>
            <td class="text-center"><%= item.requested_quantity %></td>
            <% if current_user.can_edit_inventory_reconciliation?(@reconciliation) %>
              <td class="text-center">
                <div class="form-group">
                  <input type="text" class="form-control input-sm reconcile-amount" value="<%= item.current_quantity %>" placeholder="Enter the amount" data-guard="required int" data-guard-int-min="0" />
                </div>
              </td>
              <td><button type="button" class="btn btn-default btn-sm reconcile-quantity <%= "btn-success" if @reconciliation.reconciled?(item) %>" title="Save Quantity" data-item-id="<%= item.id %>"><i class="glyphicon glyphicon-ok"></i></button></td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>
